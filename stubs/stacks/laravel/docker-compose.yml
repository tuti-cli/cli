# =============================================================================
# Laravel Stack - Base Docker Compose Configuration
# =============================================================================
# This file contains ONLY stable configurations that are shared across ALL
# environments (dev, staging, production). Environment-specific overrides
# should be placed in docker-compose.{env}.yml files.
#
# Usage:
#   Development: docker compose -f docker-compose.yml -f docker-compose.dev.yml up
#   Staging:     docker compose -f docker-compose.yml -f docker-compose.stage.yml up
#   Production:  docker compose -f docker-compose.yml -f docker-compose.prod.yml up
#
# Environment variables are loaded from ../.env (project root)
# =============================================================================

# =============================================================================
# YAML Anchors - Reusable Configuration Blocks
# =============================================================================

# -----------------------------------------------------------------------------
# Base Application Environment Variables (shared across all environments)
# These are the STABLE values that don't change between environments
# -----------------------------------------------------------------------------
x-app-env-base: &app-env-base
  # Application Core
  APP_NAME: ${APP_NAME:-Laravel}
  APP_KEY: ${APP_KEY}
  APP_TIMEZONE: ${APP_TIMEZONE:-UTC}
  APP_LOCALE: ${APP_LOCALE:-en}

  # Database Connection (configured by selected database service)
  # DB_DATABASE is only set when a database service (postgres/mysql/mariadb) is selected
  # For SQLite, Laravel uses database_path('database.sqlite') by default
  DB_CONNECTION: ${DB_CONNECTION:-sqlite}

  # Cache & Session (defaults, can be overridden per environment)
  CACHE_STORE: ${CACHE_STORE:-file}
  SESSION_DRIVER: ${SESSION_DRIVER:-file}
  SESSION_LIFETIME: 120
  QUEUE_CONNECTION: ${QUEUE_CONNECTION:-database}

  # Mail Configuration
  MAIL_MAILER: ${MAIL_MAILER:-log}
  MAIL_HOST: ${MAIL_HOST:-127.0.0.1}
  MAIL_PORT: ${MAIL_PORT:-2525}
  MAIL_USERNAME: ${MAIL_USERNAME:-null}
  MAIL_PASSWORD: ${MAIL_PASSWORD:-null}
  MAIL_ENCRYPTION: ${MAIL_ENCRYPTION:-null}
  MAIL_FROM_ADDRESS: ${MAIL_FROM_ADDRESS:-hello@example.com}
  MAIL_FROM_NAME: ${MAIL_FROM_NAME:-Laravel}

  # Logging
  LOG_CHANNEL: ${LOG_CHANNEL:-stack}
  LOG_LEVEL: ${LOG_LEVEL:-info}

  # PHP Settings (production defaults)
  PHP_MEMORY_LIMIT: ${PHP_MEMORY_LIMIT:-512M}
  PHP_MAX_EXECUTION_TIME: ${PHP_MAX_EXECUTION_TIME:-300}
  PHP_POST_MAX_SIZE: ${PHP_POST_MAX_SIZE:-100M}
  PHP_UPLOAD_MAX_FILE_SIZE: ${PHP_UPLOAD_MAX_FILE_SIZE:-100M}

# -----------------------------------------------------------------------------
# Base Build Arguments (shared across all environments)
# -----------------------------------------------------------------------------
x-app-build-base: &app-build-base
  context: ..
  dockerfile: .tuti/docker/Dockerfile
  args:
    PHP_VERSION: ${PHP_VERSION:-8.4}
    VARIANT: ${PHP_VARIANT:-fpm-nginx}

# -----------------------------------------------------------------------------
# Common Service Configuration
# -----------------------------------------------------------------------------
x-common-service: &common-service
  restart: unless-stopped
  networks:
    - app_network

# =============================================================================
# Services
# =============================================================================
services:
  # ---------------------------------------------------------------------------
  # App Service - Base Configuration
  # ---------------------------------------------------------------------------
  # Note: This is a minimal base. Environment overlays MUST specify:
  #   - build.target (development/production)
  #   - container_name
  #   - environment overrides (APP_ENV, APP_DEBUG, etc.)
  #   - volumes (if needed)
  #   - labels (Traefik configuration)
  # ---------------------------------------------------------------------------
  app:
    build:
      <<: *app-build-base
    environment:
      <<: *app-env-base
    networks:
      - traefik_proxy
      - app_network

# =============================================================================
# Networks
# =============================================================================
networks:
  traefik_proxy:
    external: true
  app_network:
    name: ${PROJECT_NAME:-laravel}_${APP_ENV:-dev}_network
    driver: bridge

# =============================================================================
# Volumes
# =============================================================================
volumes: {}
