# =============================================================================
# Laravel Stack - Development Environment Override
# =============================================================================
# This file contains ONLY development-specific configurations.
# It extends the base docker-compose.yml with development overrides.
#
# Usage: docker compose -f docker-compose.yml -f docker-compose.dev.yml up
#
# Environment variables are loaded from ../.env (project root)
#
# NOTE: Optional services (databases, cache, etc.) are added dynamically
# based on user selection during installation. Their dev overrides are
# appended to this file from service stubs.
# =============================================================================

# =============================================================================
# YAML Anchors - Development Environment Variables
# =============================================================================

# -----------------------------------------------------------------------------
# Development Environment Overrides
# These values override or extend the base x-app-env-base anchor
# -----------------------------------------------------------------------------
x-app-env-dev: &app-env-dev
  # Application - Development Mode
  APP_ENV: local
  APP_DEBUG: "true"
  APP_URL: https://${APP_DOMAIN:-app.local.test}

  # Logging - Verbose for debugging
  LOG_LEVEL: debug

  # Development Features
  TELESCOPE_ENABLED: "true"

  # PHP Settings - Development (disable caching, enable errors)
  PHP_OPCACHE_ENABLE: "0"
  PHP_ERROR_REPORTING: E_ALL
  PHP_DISPLAY_ERRORS: "1"
  PHP_DISPLAY_STARTUP_ERRORS: "1"

  # SSL - Off for local development (Traefik handles TLS termination)
  SSL_MODE: "off"

  # Autorun - Disabled in development
  AUTORUN_ENABLED: "false"

# =============================================================================
# Services
# =============================================================================
services:
  # ---------------------------------------------------------------------------
  # App Service - Development Configuration
  # ---------------------------------------------------------------------------
  app:
    build:
      target: development
      args:
        USER_ID: ${DOCKER_USER_ID:-1000}
        GROUP_ID: ${DOCKER_GROUP_ID:-1000}
    container_name: ${PROJECT_NAME:-laravel}_${APP_ENV:-dev}_app
    environment:
      <<: *app-env-dev
    volumes:
      # Mount entire Laravel app for hot reload (parent directory is project root)
      - ..:/var/www/html:cached
    labels:
      # Enable Traefik
      - "traefik.enable=true"
      - "traefik.docker.network=traefik_proxy"

      # HTTP Router (redirect to HTTPS)
      - "traefik.http.routers.${PROJECT_NAME:-laravel}-http.rule=Host(`${APP_DOMAIN:-app.local.test}`)"
      - "traefik.http.routers.${PROJECT_NAME:-laravel}-http.entrypoints=web"
      - "traefik.http.routers.${PROJECT_NAME:-laravel}-http.middlewares=redirect-to-https"

      # HTTPS Router
      - "traefik.http.routers.${PROJECT_NAME:-laravel}.rule=Host(`${APP_DOMAIN:-app.local.test}`)"
      - "traefik.http.routers.${PROJECT_NAME:-laravel}.entrypoints=websecure"
      - "traefik.http.routers.${PROJECT_NAME:-laravel}.tls=true"
      - "traefik.http.routers.${PROJECT_NAME:-laravel}.service=${PROJECT_NAME:-laravel}"

      # Service Definition
      - "traefik.http.services.${PROJECT_NAME:-laravel}.loadbalancer.server.port=8080"

      # Middleware for HTTP to HTTPS redirect
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"

# =============================================================================
# Optional Services (added dynamically from stubs)
# =============================================================================
# Database, cache, search, storage, mail, and worker services are appended
# here by StackInitializationService::appendDevSectionsToDevCompose() when
# selected during installation.
