# =============================================================================
# WordPress Stack - Development Environment Override
# =============================================================================
# This file contains ONLY development-specific configurations.
# It extends the base docker-compose.yml with development overrides.
#
# Usage: docker compose -f docker-compose.yml -f docker-compose.dev.yml up
#
# Environment variables are loaded from ../.env (project root)
# =============================================================================

# =============================================================================
# YAML Anchors - Development Environment Variables
# =============================================================================

# -----------------------------------------------------------------------------
# Development Environment Overrides
# These values override or extend the base x-app-env-base anchor
# -----------------------------------------------------------------------------
x-app-env-dev: &app-env-dev
  # WordPress - Development Mode
  WORDPRESS_DEBUG: "true"
  WORDPRESS_DEBUG_LOG: "true"
  WORDPRESS_DEBUG_DISPLAY: "true"

  # WordPress URL Configuration
  WORDPRESS_HOME: https://${APP_DOMAIN:-wordpress.local.test}
  WORDPRESS_SITEURL: https://${APP_DOMAIN:-wordpress.local.test}

  # PHP Settings - Development (disable caching, enable errors)
  PHP_OPCACHE_ENABLE: "0"
  PHP_ERROR_REPORTING: E_ALL
  PHP_DISPLAY_ERRORS: "1"
  PHP_DISPLAY_STARTUP_ERRORS: "1"

  # SSL - Off for local development (Traefik handles TLS termination)
  SSL_MODE: "off"

  # Autorun - Disabled in development
  AUTORUN_ENABLED: "false"

# =============================================================================
# Services
# =============================================================================
services:
  # ---------------------------------------------------------------------------
  # App Service - Development Configuration
  # ---------------------------------------------------------------------------
  app:
    container_name: ${PROJECT_NAME:-wordpress}_${APP_ENV:-dev}_app
    environment:
      <<: *app-env-dev
    volumes:
      # Mount WordPress installation for development
      # Standard: mount entire WordPress directory
      # Bedrock: mount project directory
      - ..:/var/www/html:cached
    labels:
      # Enable Traefik
      - "traefik.enable=true"
      - "traefik.docker.network=traefik_proxy"

      # HTTP Router (redirect to HTTPS)
      - "traefik.http.routers.${PROJECT_NAME:-wordpress}-http.rule=Host(`${APP_DOMAIN:-wordpress.local.test}`)"
      - "traefik.http.routers.${PROJECT_NAME:-wordpress}-http.entrypoints=web"
      - "traefik.http.routers.${PROJECT_NAME:-wordpress}-http.middlewares=redirect-to-https"

      # HTTPS Router
      - "traefik.http.routers.${PROJECT_NAME:-wordpress}.rule=Host(`${APP_DOMAIN:-wordpress.local.test}`)"
      - "traefik.http.routers.${PROJECT_NAME:-wordpress}.entrypoints=websecure"
      - "traefik.http.routers.${PROJECT_NAME:-wordpress}.tls=true"
      - "traefik.http.routers.${PROJECT_NAME:-wordpress}.service=${PROJECT_NAME:-wordpress}"

      # Service Definition (Apache serves on port 8080 in serversideup/php)
      - "traefik.http.services.${PROJECT_NAME:-wordpress}.loadbalancer.server.port=8080"

      # Middleware for HTTP to HTTPS redirect
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"

  # ---------------------------------------------------------------------------
  # Database Service - Development Overrides
  # The database configuration comes from the selected service stub
  # ---------------------------------------------------------------------------
  database:
    container_name: ${PROJECT_NAME:-wordpress}_${APP_ENV:-dev}_database
    # Expose port to host for local database tools (DBeaver, TablePlus, etc.)
    ports:
      - "${DB_EXTERNAL_PORT:-3306}:3306"

  # ---------------------------------------------------------------------------
  # Mailpit - Development Only (local email testing)
  # ---------------------------------------------------------------------------
  mailpit:
    image: axllent/mailpit:latest
    container_name: ${PROJECT_NAME:-wordpress}_${APP_ENV:-dev}_mailpit
    restart: unless-stopped
    networks:
      - traefik_proxy
      - app_network
    environment:
      MP_SMTP_AUTH_ACCEPT_ANY: "true"
      MP_SMTP_AUTH_ALLOW_INSECURE: "true"
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik_proxy"
      - "traefik.http.routers.${PROJECT_NAME:-wordpress}-mail.rule=Host(`mail.${APP_DOMAIN:-wordpress.local.test}`)"
      - "traefik.http.routers.${PROJECT_NAME:-wordpress}-mail.entrypoints=websecure"
      - "traefik.http.routers.${PROJECT_NAME:-wordpress}-mail.tls=true"
      - "traefik.http.services.${PROJECT_NAME:-wordpress}-mail.loadbalancer.server.port=8025"
