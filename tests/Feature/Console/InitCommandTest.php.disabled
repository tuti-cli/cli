<?php

declare(strict_types=1);

use App\Services\Project\ProjectInitializationService;
use Illuminate\Support\Facades\File;
use Mockery\MockInterface;

beforeEach(function (): void {
    $this->testDir = sys_get_temp_dir() . '/tuti-init-test-' . uniqid();
    mkdir($this->testDir);
    chdir($this->testDir);
});

afterEach(function (): void {
    if (property_exists($this, 'testDir') && $this->testDir !== null && is_dir($this->testDir)) {
        File::deleteDirectory($this->testDir);
    }
});

it('initializes a new project successfully', function (): void {
    $this->artisan('init testproject --no-interaction')
        ->assertSuccessful()
        ->expectsOutputToContain('Project initialized successfully!');

    expect(is_dir('.tuti'))->toBeTrue()
        ->and(file_exists('.tuti/config.json'))->toBeTrue();
});

it('creates config.json with correct structure', function (): void {
    $this->artisan('init myapp --env=dev --no-interaction')
        ->assertSuccessful();

    $config = json_decode(file_get_contents('.tuti/config.json'), true);

    expect($config)->toHaveKey('project')
        ->and($config['project'])->toHaveKey('name', 'myapp')
        ->and($config['project'])->toHaveKey('type', 'custom')
        ->and($config['project'])->toHaveKey('version', '1.0.0')
        ->and($config)->toHaveKey('environments')
        ->and($config['environments'])->toHaveKey('current', 'dev')
        ->and($config)->toHaveKey('initialized_at');
});

it('creates all required directories', function (): void {
    $this->artisan('init testproject --no-interaction')
        ->assertSuccessful();

    expect(is_dir('.tuti/docker'))->toBeTrue()
        ->and(is_dir('.tuti/environments'))->toBeTrue()
        ->and(is_dir('.tuti/scripts'))->toBeTrue();
});

it('fails when project is already initialized', function (): void {
    $this->artisan('init testproject --no-interaction')
        ->assertSuccessful();

    $this->artisan('init testproject --no-interaction')
        ->assertFailed()
        ->expectsOutputToContain('Project already initialized');
});

it('reinitializes with --force flag', function (): void {
    $this->artisan('init testproject --no-interaction')
        ->assertSuccessful();

    // Modify config to verify it gets replaced
    file_put_contents('.tuti/config.json', '{"test": "old"}');

    $this->artisan('init newproject --force --no-interaction')
        ->assertSuccessful();

    $config = json_decode(file_get_contents('.tuti/config.json'), true);

    expect($config['project']['name'])->toBe('newproject');
});

it('uses current directory name as default project name', function (): void {
    $dirName = basename(getcwd());

    $this->artisan('init --no-interaction')
        ->assertSuccessful();

    $config = json_decode(file_get_contents('.tuti/config.json'), true);

    expect($config['project']['name'])->toBe($dirName);
});

it('accepts environment option', function (): void {
    $this->artisan('init testproject --env=staging --no-interaction')
        ->assertSuccessful();

    $config = json_decode(file_get_contents('.tuti/config.json'), true);

    expect($config['environments']['current'])->toBe('staging');
});

it('defaults to dev environment', function (): void {
    $this->artisan('init testproject --no-interaction')
        ->assertSuccessful();

    $config = json_decode(file_get_contents('.tuti/config.json'), true);

    expect($config['environments']['current'])->toBe('dev');
});

it('cleans up on failure', function (): void {
    // Mock the initialization service to throw an exception
    $this->mock(ProjectInitializationService::class, function (MockInterface $mock): void {
        $mock->shouldReceive('initialize')
            ->once()
            ->andThrow(new RuntimeException('Test failure'));
    });

    $this->artisan('init testproject --no-interaction')
        ->assertFailed()
        ->expectsOutputToContain('Initialization failed');

    // Directory should be cleaned up
    expect(is_dir('.tuti'))->toBeFalse();
});

it('displays next steps after successful initialization', function (): void {
    $this->artisan('init testproject --no-interaction')
        ->assertSuccessful()
        ->expectsOutputToContain('Next Steps:')
        ->expectsOutputToContain('Place your docker-compose.yml in .tuti/docker/')
        ->expectsOutputToContain('tuti local:start');
});

it('creates domain configuration for environment', function (): void {
    $this->artisan('init myproject --no-interaction')
        ->assertSuccessful();

    $config = json_decode(file_get_contents('.tuti/config.json'), true);

    expect($config['environments']['dev'])->toHaveKey('domain', 'myproject.test');
});

it('delegates to ProjectInitializationService', function (): void {
    $initService = $this->mock(ProjectInitializationService::class, function (MockInterface $mock): void {
        $mock->shouldReceive('initialize')
            ->once()
            ->with('testproject', 'dev')
            ->andReturn(true);
    });

    $this->artisan('init testproject --no-interaction')
        ->assertSuccessful();
});
