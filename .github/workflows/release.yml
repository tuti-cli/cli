name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  PHP_VERSION: '8.4'

jobs:
  build:
    name: Build PHAR and Binaries
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, zip, phar, sodium
          tools: composer:v2
          ini-values: phar.readonly=0

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          composer install --optimize-autoloader --no-interaction
          echo "=== Checking vendor/bin directory ==="
          ls -la vendor/bin/ | grep phpacker || echo "phpacker not found"
          echo "=== Checking if phpacker is executable ==="
          file vendor/bin/phpacker || echo "phpacker file not found"

      - name: Build PHAR
        run: php tuti app:build tuti.phar --build-version=${{ steps.version.outputs.VERSION }}

      - name: Test PHAR
        run: |
          php builds/tuti.phar --version
          php builds/tuti.phar list | head -20

      - name: Build all binaries with phpacker
        run: |
          echo "=== Verifying phpacker before build ==="
          if [ ! -f "vendor/bin/phpacker" ]; then
            echo "phpacker not found, installing explicitly..."
            composer require phpacker/phpacker --dev
          fi
          ls -la vendor/bin/phpacker
          file vendor/bin/phpacker
          mkdir -p builds/build /tmp/phpacker-cache
          chmod -R 777 builds/build /tmp/phpacker-cache
          HOME=/tmp PHPACKER_CACHE=/tmp/phpacker-cache ./vendor/bin/phpacker build --src=./builds/tuti.phar --php=8.4 all

      - name: Verify binaries
        run: |
          echo "=== Binaries created ==="
          ls -laR builds/build/
          echo "=== Testing Linux x64 binary ==="
          file builds/build/linux/linux-x64
          echo "=== Checking binary is executable ==="
          chmod +x builds/build/linux/linux-x64
          ./builds/build/linux/linux-x64 --version
          echo "=== Binary works! ==="
          echo "=== Binary sizes ==="
          ls -lh builds/build/linux/
          ls -lh builds/build/mac/ || true

      - name: Prepare release files
        run: |
          mkdir -p release
          # PHAR
          cp builds/tuti.phar release/
          # Rename binaries to standard format for install script (copy only if exists)
          cp builds/build/linux/linux-x64 release/tuti-linux-amd64 2>/dev/null || echo "linux-x64 not found"
          cp builds/build/linux/linux-arm64 release/tuti-linux-arm64 2>/dev/null || echo "linux-arm64 not found"
          cp builds/build/mac/mac-x64 release/tuti-darwin-amd64 2>/dev/null || echo "mac-x64 not found"
          cp builds/build/mac/mac-arm64 release/tuti-darwin-arm64 2>/dev/null || echo "mac-arm64 not found"
          cp builds/build/windows/windows-x64.exe release/tuti-windows-amd64.exe 2>/dev/null || echo "windows-x64 not found"
          chmod +x release/* 2>/dev/null || true
          echo "=== Release files ==="
          ls -lh release/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/*
            scripts/install.sh
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          generate_release_notes: true
          body: |
            ## ðŸ“¦ Installation

            ### Quick Install (Recommended)
            ```bash
            curl -fsSL https://raw.githubusercontent.com/tuti-cli/cli/main/scripts/install.sh | bash
            ```

            **âœ… NO PHP REQUIRED!** These binaries are truly self-contained with embedded PHP runtime.

            ### Manual Install

            **Linux (x64):**
            ```bash
            curl -fsSL https://github.com/tuti-cli/cli/releases/download/v${{ steps.version.outputs.VERSION }}/tuti-linux-amd64 -o tuti
            chmod +x tuti
            sudo mv tuti /usr/local/bin/
            tuti install
            ```

            **Linux (ARM64):**
            ```bash
            curl -fsSL https://github.com/tuti-cli/cli/releases/download/v${{ steps.version.outputs.VERSION }}/tuti-linux-arm64 -o tuti
            chmod +x tuti
            sudo mv tuti /usr/local/bin/
            tuti install
            ```

            **macOS (Apple Silicon):**
            ```bash
            curl -fsSL https://github.com/tuti-cli/cli/releases/download/v${{ steps.version.outputs.VERSION }}/tuti-darwin-arm64 -o tuti
            chmod +x tuti
            sudo mv tuti /usr/local/bin/
            tuti install
            ```

            **macOS (Intel):**
            ```bash
            curl -fsSL https://github.com/tuti-cli/cli/releases/download/v${{ steps.version.outputs.VERSION }}/tuti-darwin-amd64 -o tuti
            chmod +x tuti
            sudo mv tuti /usr/local/bin/
            tuti install
            ```

            ### How It Works
            - Binaries include embedded PHP runtime (built with phpacker)
            - No system PHP installation required
            - Single executable file (~25-50MB per binary)

            ### Verify Installation
            ```bash
            tuti --version
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
