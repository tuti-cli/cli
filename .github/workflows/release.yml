name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  PHP_VERSION: '8.4'

jobs:
  build:
    name: Build PHAR and Binaries
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, zip, phar, sodium
          tools: composer:v2
          ini-values: phar.readonly=0

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: composer install --no-dev --optimize-autoloader --no-interaction

      - name: Build PHAR
        run: php tuti app:build tuti.phar --build-version=${{ steps.version.outputs.VERSION }}

      - name: Test PHAR
        run: |
          php builds/tuti.phar --version
          php builds/tuti.phar list | head -20

      - name: Build all binaries with phpacker
        run: ./vendor/bin/phpacker build --src=./builds/tuti.phar --php=8.4 all

      - name: List built files
        run: |
          echo "=== PHAR ==="
          ls -la builds/tuti.phar
          echo "=== Binaries ==="
          ls -laR builds/build/

      - name: Prepare release files
        run: |
          mkdir -p release
          # PHAR
          cp builds/tuti.phar release/
          # Linux binaries
          cp builds/build/linux/linux-x64 release/tuti-linux-amd64 2>/dev/null || true
          cp builds/build/linux/linux-arm64 release/tuti-linux-arm64 2>/dev/null || true
          # macOS binaries
          cp builds/build/mac/mac-x64 release/tuti-darwin-amd64 2>/dev/null || true
          cp builds/build/mac/mac-arm64 release/tuti-darwin-arm64 2>/dev/null || true
          # Windows binary
          cp builds/build/windows/windows-x64.exe release/tuti-windows-amd64.exe 2>/dev/null || true
          # Make all executable
          chmod +x release/* 2>/dev/null || true
          ls -la release/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/*
            scripts/install.sh
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          generate_release_notes: true
          body: |
            ## ðŸ“¦ Installation

            ### Quick Install (Recommended)
            ```bash
            curl -fsSL https://raw.githubusercontent.com/tuti-cli/cli/main/scripts/install.sh | bash
            ```

            **No PHP required!** The binary includes embedded PHP runtime.

            ### Manual Install

            **Linux (x64):**
            ```bash
            curl -fsSL https://github.com/tuti-cli/cli/releases/download/v${{ steps.version.outputs.VERSION }}/tuti-linux-amd64 -o tuti
            chmod +x tuti
            sudo mv tuti /usr/local/bin/
            tuti install
            ```

            **Linux (ARM64):**
            ```bash
            curl -fsSL https://github.com/tuti-cli/cli/releases/download/v${{ steps.version.outputs.VERSION }}/tuti-linux-arm64 -o tuti
            chmod +x tuti
            sudo mv tuti /usr/local/bin/
            tuti install
            ```

            **macOS (Apple Silicon):**
            ```bash
            curl -fsSL https://github.com/tuti-cli/cli/releases/download/v${{ steps.version.outputs.VERSION }}/tuti-darwin-arm64 -o tuti
            chmod +x tuti
            sudo mv tuti /usr/local/bin/
            tuti install
            ```

            **macOS (Intel):**
            ```bash
            curl -fsSL https://github.com/tuti-cli/cli/releases/download/v${{ steps.version.outputs.VERSION }}/tuti-darwin-amd64 -o tuti
            chmod +x tuti
            sudo mv tuti /usr/local/bin/
            tuti install
            ```

            **Windows (x64):**
            ```powershell
            Invoke-WebRequest -Uri "https://github.com/tuti-cli/cli/releases/download/v${{ steps.version.outputs.VERSION }}/tuti-windows-amd64.exe" -OutFile "tuti.exe"
            ```

            ### Verify Installation
            ```bash
            tuti --version
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
