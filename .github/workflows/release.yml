name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  PHP_VERSION: '8.4'

jobs:
  build-phar:
    name: Build PHAR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, zip, phar, sodium
          tools: composer:v2
          ini-values: phar.readonly=0

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: composer install --no-dev --optimize-autoloader --no-interaction

      - name: Build PHAR
        run: php tuti app:build tuti --build-version=${{ steps.version.outputs.VERSION }}

      - name: Test PHAR
        run: |
          php builds/tuti --version
          php builds/tuti list | head -20

      - name: Upload PHAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: phar
          path: builds/tuti

  build-linux-amd64:
    name: Build Linux x64 Binary
    needs: build-phar
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download PHAR
        uses: actions/download-artifact@v4
        with:
          name: phar
          path: builds/

      - name: Download static PHP
        run: |
          # Download pre-built static PHP for Linux x64
          curl -fsSL https://dl.static-php.dev/static-php-cli/common/php-8.4.2-cli-linux-x86_64.tar.gz -o php-static.tar.gz
          tar -xzf php-static.tar.gz
          chmod +x php
          ./php -v

      - name: Create self-contained binary
        run: |
          mkdir -p builds/bin
          chmod +x builds/tuti
          # Create a self-extracting binary with embedded PHP + PHAR
          cat > builds/bin/tuti-linux-amd64 << 'WRAPPER'
          #!/bin/bash
          SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          TEMP_DIR="${HOME}/.tuti/runtime"
          mkdir -p "$TEMP_DIR"

          # Extract embedded files if not exists or outdated
          if [ ! -f "$TEMP_DIR/php" ] || [ "$0" -nt "$TEMP_DIR/php" ]; then
            tail -n +MARKER_LINE "$0" | tar -xzf - -C "$TEMP_DIR" 2>/dev/null
          fi

          # Run the PHAR with embedded PHP
          exec "$TEMP_DIR/php" "$TEMP_DIR/tuti.phar" "$@"
          exit $?
          WRAPPER

          # Calculate marker line
          MARKER_LINE=$(($(wc -l < builds/bin/tuti-linux-amd64) + 1))
          sed -i "s/MARKER_LINE/$MARKER_LINE/" builds/bin/tuti-linux-amd64

          # Create tar with PHP and PHAR
          mv builds/tuti tuti.phar
          tar -czf payload.tar.gz php tuti.phar
          cat payload.tar.gz >> builds/bin/tuti-linux-amd64
          chmod +x builds/bin/tuti-linux-amd64

          # Test the binary
          ./builds/bin/tuti-linux-amd64 --version || echo "Binary created (test may fail in CI)"

      - name: Upload Linux x64 binary
        uses: actions/upload-artifact@v4
        with:
          name: binary-linux-amd64
          path: builds/bin/tuti-linux-amd64

  build-linux-arm64:
    name: Build Linux ARM64 Binary
    needs: build-phar
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download PHAR
        uses: actions/download-artifact@v4
        with:
          name: phar
          path: builds/

      - name: Download static PHP for ARM64
        run: |
          curl -fsSL https://dl.static-php.dev/static-php-cli/common/php-8.4.2-cli-linux-aarch64.tar.gz -o php-static.tar.gz
          tar -xzf php-static.tar.gz
          chmod +x php

      - name: Create self-contained binary
        run: |
          mkdir -p builds/bin
          chmod +x builds/tuti
          cat > builds/bin/tuti-linux-arm64 << 'WRAPPER'
          #!/bin/bash
          TEMP_DIR="${HOME}/.tuti/runtime"
          mkdir -p "$TEMP_DIR"
          if [ ! -f "$TEMP_DIR/php" ] || [ "$0" -nt "$TEMP_DIR/php" ]; then
            tail -n +MARKER_LINE "$0" | tar -xzf - -C "$TEMP_DIR" 2>/dev/null
          fi
          exec "$TEMP_DIR/php" "$TEMP_DIR/tuti.phar" "$@"
          exit $?
          WRAPPER
          MARKER_LINE=$(($(wc -l < builds/bin/tuti-linux-arm64) + 1))
          sed -i "s/MARKER_LINE/$MARKER_LINE/" builds/bin/tuti-linux-arm64
          mv builds/tuti tuti.phar
          tar -czf payload.tar.gz php tuti.phar
          cat payload.tar.gz >> builds/bin/tuti-linux-arm64
          chmod +x builds/bin/tuti-linux-arm64

      - name: Upload Linux ARM64 binary
        uses: actions/upload-artifact@v4
        with:
          name: binary-linux-arm64
          path: builds/bin/tuti-linux-arm64

  build-macos-amd64:
    name: Build macOS x64 Binary
    needs: build-phar
    runs-on: macos-13
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download PHAR
        uses: actions/download-artifact@v4
        with:
          name: phar
          path: builds/

      - name: Download static PHP for macOS x64
        run: |
          curl -fsSL https://dl.static-php.dev/static-php-cli/common/php-8.4.2-cli-macos-x86_64.tar.gz -o php-static.tar.gz
          tar -xzf php-static.tar.gz
          chmod +x php
          ./php -v

      - name: Create self-contained binary
        run: |
          mkdir -p builds/bin
          chmod +x builds/tuti
          cat > builds/bin/tuti-darwin-amd64 << 'WRAPPER'
          #!/bin/bash
          TEMP_DIR="${HOME}/.tuti/runtime"
          mkdir -p "$TEMP_DIR"
          if [ ! -f "$TEMP_DIR/php" ] || [ "$0" -nt "$TEMP_DIR/php" ]; then
            tail -n +MARKER_LINE "$0" | tar -xzf - -C "$TEMP_DIR" 2>/dev/null
          fi
          exec "$TEMP_DIR/php" "$TEMP_DIR/tuti.phar" "$@"
          exit $?
          WRAPPER
          MARKER_LINE=$(($(wc -l < builds/bin/tuti-darwin-amd64) + 1))
          sed -i '' "s/MARKER_LINE/$MARKER_LINE/" builds/bin/tuti-darwin-amd64
          mv builds/tuti tuti.phar
          tar -czf payload.tar.gz php tuti.phar
          cat payload.tar.gz >> builds/bin/tuti-darwin-amd64
          chmod +x builds/bin/tuti-darwin-amd64

      - name: Upload macOS x64 binary
        uses: actions/upload-artifact@v4
        with:
          name: binary-darwin-amd64
          path: builds/bin/tuti-darwin-amd64

  build-macos-arm64:
    name: Build macOS ARM64 Binary
    needs: build-phar
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download PHAR
        uses: actions/download-artifact@v4
        with:
          name: phar
          path: builds/

      - name: Download static PHP for macOS ARM64
        run: |
          curl -fsSL https://dl.static-php.dev/static-php-cli/common/php-8.4.2-cli-macos-aarch64.tar.gz -o php-static.tar.gz
          tar -xzf php-static.tar.gz
          chmod +x php
          ./php -v

      - name: Create self-contained binary
        run: |
          mkdir -p builds/bin
          chmod +x builds/tuti
          cat > builds/bin/tuti-darwin-arm64 << 'WRAPPER'
          #!/bin/bash
          TEMP_DIR="${HOME}/.tuti/runtime"
          mkdir -p "$TEMP_DIR"
          if [ ! -f "$TEMP_DIR/php" ] || [ "$0" -nt "$TEMP_DIR/php" ]; then
            tail -n +MARKER_LINE "$0" | tar -xzf - -C "$TEMP_DIR" 2>/dev/null
          fi
          exec "$TEMP_DIR/php" "$TEMP_DIR/tuti.phar" "$@"
          exit $?
          WRAPPER
          MARKER_LINE=$(($(wc -l < builds/bin/tuti-darwin-arm64) + 1))
          sed -i '' "s/MARKER_LINE/$MARKER_LINE/" builds/bin/tuti-darwin-arm64
          mv builds/tuti tuti.phar
          tar -czf payload.tar.gz php tuti.phar
          cat payload.tar.gz >> builds/bin/tuti-darwin-arm64
          chmod +x builds/bin/tuti-darwin-arm64

      - name: Upload macOS ARM64 binary
        uses: actions/upload-artifact@v4
        with:
          name: binary-darwin-arm64
          path: builds/bin/tuti-darwin-arm64

  release:
    name: Create Release
    needs: [build-phar, build-linux-amd64, build-linux-arm64, build-macos-amd64, build-macos-arm64]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Prepare release files
        run: |
          mkdir -p release
          # PHAR (for users with PHP)
          cp artifacts/phar/tuti release/tuti.phar
          chmod +x release/tuti.phar
          # Native binaries (no PHP required!)
          cp artifacts/binary-linux-amd64/tuti-linux-amd64 release/ 2>/dev/null || true
          cp artifacts/binary-linux-arm64/tuti-linux-arm64 release/ 2>/dev/null || true
          cp artifacts/binary-darwin-amd64/tuti-darwin-amd64 release/ 2>/dev/null || true
          cp artifacts/binary-darwin-arm64/tuti-darwin-arm64 release/ 2>/dev/null || true
          chmod +x release/* 2>/dev/null || true
          ls -la release/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/*
            scripts/install.sh
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          generate_release_notes: true
          body: |
            ## ðŸ“¦ Installation

            ### Quick Install (Recommended)
            ```bash
            curl -fsSL https://raw.githubusercontent.com/tuti-cli/cli/main/scripts/install.sh | bash
            ```

            **No PHP required!** The binary includes everything needed to run.

            ### Manual Install

            **Linux (x64):**
            ```bash
            curl -fsSL https://github.com/tuti-cli/cli/releases/download/v${{ steps.version.outputs.VERSION }}/tuti-linux-amd64 -o tuti
            chmod +x tuti
            sudo mv tuti /usr/local/bin/
            tuti install
            ```

            **Linux (ARM64):**
            ```bash
            curl -fsSL https://github.com/tuti-cli/cli/releases/download/v${{ steps.version.outputs.VERSION }}/tuti-linux-arm64 -o tuti
            chmod +x tuti
            sudo mv tuti /usr/local/bin/
            tuti install
            ```

            **macOS (Apple Silicon):**
            ```bash
            curl -fsSL https://github.com/tuti-cli/cli/releases/download/v${{ steps.version.outputs.VERSION }}/tuti-darwin-arm64 -o tuti
            chmod +x tuti
            sudo mv tuti /usr/local/bin/
            tuti install
            ```

            **macOS (Intel):**
            ```bash
            curl -fsSL https://github.com/tuti-cli/cli/releases/download/v${{ steps.version.outputs.VERSION }}/tuti-darwin-amd64 -o tuti
            chmod +x tuti
            sudo mv tuti /usr/local/bin/
            tuti install
            ```

            ### Verify Installation
            ```bash
            tuti --version
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
