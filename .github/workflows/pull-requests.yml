name: Pull Requests

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  pr-validation:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Check PR title follows Conventional Commits
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.pull_request.title;
            const conventionalPattern = /^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?\!?:\s.+$/;

            if (!conventionalPattern.test(title)) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ðŸ“ PR Title Check\n\nYour PR title doesn't follow [Conventional Commits](https://www.conventionalcommits.org/) format.\n\n**Current title:** ${title}\n\n**Expected format:** \`type(scope): subject\`\n\n**Valid types:**\n- \`feat\` - New feature\n- \`fix\` - Bug fix\n- \`docs\` - Documentation changes\n- \`style\` - Code style changes (formatting)\n- \`refactor\` - Code refactoring\n- \`test\` - Adding/updating tests\n- \`chore\` - Maintenance tasks\n- \`perf\` - Performance improvements\n- \`ci\` - CI/CD changes\n- \`build\` - Build system changes\n\n**Examples:**\n- \`feat(local): add port conflict detection\`\n- \`fix(docker): resolve container naming issue\`\n- \`docs(readme): update installation instructions\`\n\n---\n_Please update your PR title._`
              });
            }

      - name: Welcome first-time contributors
        uses: actions/github-script@v7
        with:
          script: |
            const author = context.payload.pull_request.user.login;
            const { data: prs } = await github.rest.search.issuesAndPullRequests({
              q: `author:${author} is:pr repo:${context.repo.owner}/${context.repo.repo}`,
              per_page: 1
            });

            if (prs.total_count === 1) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ðŸŽ‰ Welcome, @${author}!\n\nThank you for your first contribution to Tuti CLI!\n\n### Quick Checklist:\n- [ ] PR follows [Conventional Commits](https://www.conventionalcommits.org/)\n- [ ] Tests pass locally (\`composer test\`)\n- [ ] Code follows PSR-12 (checked by Pint)\n- [ ] No PHPStan errors (\`composer test:types\`)\n\n### Review Process:\n1. Automated tests will run on your PR\n2. A maintainer will review your changes\n3. Address any feedback\n4. Once approved, your PR will be merged\n\nWe appreciate your contribution! ðŸš€\n\n---\n_This is an automated welcome message._`
              });
            }

      - name: Add size label
        uses: actions/github-script@v7
        with:
          script: |
            const changedFiles = context.payload.pull_request.changed_files;
            const additions = context.payload.pull_request.additions;
            const deletions = context.payload.pull_request.deletions;
            const totalChanges = additions + deletions;

            let sizeLabel = 'size: XS';
            if (totalChanges > 500) sizeLabel = 'size: XL';
            else if (totalChanges > 200) sizeLabel = 'size: L';
            else if (totalChanges > 50) sizeLabel = 'size: M';
            else if (totalChanges > 10) sizeLabel = 'size: S';

            try {
              await github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: [sizeLabel]
              });
            } catch (e) {
              // Label might not exist, create it
              if (e.status === 404) {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: sizeLabel,
                  color: '5D9CEC'
                });
                await github.rest.issues.addLabels({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  labels: [sizeLabel]
                });
              }
            }
