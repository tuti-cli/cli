name: Update Changelog

on:
  release:
    types: [released]

permissions:
  contents: write

jobs:
  update-changelog:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, zip

      - name: Get release version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate changelog entry
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          DATE=$(date +%Y-%m-%d)

          # Get previous tag for comparison
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          # Generate changelog section
          echo "## [v${VERSION}] - ${DATE}" > /tmp/changelog_entry.md

          # Get commits since last release
          if [ -n "$PREV_TAG" ]; then
            echo "" >> /tmp/changelog_entry.md
            git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges >> /tmp/changelog_entry.md
          else
            git log --pretty=format:"- %s (%h)" --no-merges -20 >> /tmp/changelog_entry.md
          fi

          echo "" >> /tmp/changelog_entry.md
          echo "" >> /tmp/changelog_entry.md

          cat /tmp/changelog_entry.md

      - name: Update CHANGELOG.md
        run: |
          if [ -f "CHANGELOG.md" ]; then
            # Insert new entry after the header
            sed -i '/<!-- changelog starts -->/r /tmp/changelog_entry.md' CHANGELOG.md
          else
            # Create new changelog
            cat > CHANGELOG.md << 'HEADER'
            # Changelog

            All notable changes to this project will be documented in this file.

            The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.1.0/),
            and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

            <!-- changelog starts -->
            HEADER
            cat /tmp/changelog_entry.md >> CHANGELOG.md
          fi

      - name: Commit changelog update
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add CHANGELOG.md
          git commit -m "docs(changelog): update for v${{ steps.version.outputs.VERSION }}" || echo "No changes to commit"
          git push

      - name: Create summary
        run: |
          echo "### ðŸ“ Changelog Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Version: v${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat /tmp/changelog_entry.md >> $GITHUB_STEP_SUMMARY
